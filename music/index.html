<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>云音乐 - 在线音乐播放器</title>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    [v-cloak] { display: none; } .cursor { cursor: pointer; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: #0c0c0c; color: #fff; overflow-x: hidden; }
    .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: -2; }
    .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); z-index: -1; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }}
    .hide { display: none !important; }
    .wrap-box { background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 20px; backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .navbar { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 15px 0; position: sticky; top: 0; z-index: 100; }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: bold; color: #fff; }
    .logo i { color: #ff6b6b; font-size: 28px; margin-right: 12px; }
    .search-container { flex: 1; max-width: 600px; margin: 0 40px; position: relative; }
    .search-wrapper { display: flex; background: rgba(255, 255, 255, 0.15); border-radius: 25px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
    .search-input { flex: 1; padding: 12px 20px; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; filter: brightness(6); }
    .source-select { background: rgba(255, 255, 255, 0.1); border: none; color: #fff; padding: 12px 15px; outline: none; cursor: pointer; }
    .source-select option { background: #2a2a2a; color: #fff; padding: 8px; }
    .search-btn { background: #ff6b6b; border: none; color: #fff; padding: 12px 20px; cursor: pointer; transition: all 0.3s ease; }
    .search-btn:hover { background: #ff5252; }
    .main-container { max-width: 1600px; margin: 0 auto; padding: 30px; display: grid; grid-template-columns: 2.5fr 2fr 2fr; gap: 25px; min-height: calc(100vh - 200px); align-items: start; }
    .content-section { min-width: 0; overflow: hidden; min-height: 60vh; }
    .section-title { font-size: 20px; font-weight: 600; margin-bottom: 14px; color: #fff; display: flex; align-items: center; gap: 10px;padding-right: 14px; }
    .section-title span { font-size: 14px; font-weight: 300; flex: 1; }
    .search-results { max-height: 670px; overflow-y: auto; }
    .song-item { display: flex; align-items: center; padding: 10px 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 8px; position: relative; overflow: hidden; }
    .song-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
    .song-item.active { background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.1)); border: 1px solid rgba(255, 107, 107, 0.5); }
    .song-index { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 14px; font-weight: 600; color: rgba(255, 255, 255, 0.7); }
    .song-item.active .song-index { background: linear-gradient(135deg, #ff6b6b, #ff5252); color: #fff; }
    .song-info { flex: 1; width: 0; position: relative; }
    .song-info i { position: absolute; top: 2px; right: 2px;color: #ababab; display: none; }
    .song-info:hover i { display: block; }
    .song-name { font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-artist { color: rgba(255, 255, 255, 0.7); font-size: .8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-duration { color: rgba(255, 255, 255, 0.5); font-size: .8em; margin-left: 15px; display: none; }
    .player-section { xposition: sticky; top: 120px; height: fit-content; min-height: calc(100vh - 240px); display: flex; flex-direction: column; justify-content: space-between; }
    .current-song { text-align: center; margin-bottom: 25px; }
    .current-cover-container { position: relative; display: inline-block; margin-bottom: 20px; }
    .current-cover { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); transition: all 0.3s ease; border: 6px solid rgba(255, 255, 255, 0.1); position: relative; }
    .current-cover.playing { animation: rotate 20s linear infinite; }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); }  }
    .current-info h3 { font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #fff; }
    .current-info p { color: rgba(255, 255, 255, 0.7); font-size: 16px; }
    .player-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; }
    .control-btn { background: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; color: #fff; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .control-btn:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
    .control-btn.small { width: 45px; height: 45px; font-size: 18px; }
    .play-btn { width: 65px; height: 65px; font-size: 28px; background: linear-gradient(135deg, #ff6b6b, #ff5252); box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); }
    .play-btn:hover { background: linear-gradient(135deg, #ff5252, #ff4444); box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6); }
    .progress-container { margin-bottom: 20px; }
    .progress-bar { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.2); border-radius: 3px; cursor: pointer; margin-bottom: 10px; position: relative; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #ff6b6b, #ff8a80); border-radius: 3px; width: 0%; transition: width 0.1s ease; position: relative; }
    .progress-fill::after { content: ''; position: absolute; right: -2px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
    .time-info { display: flex; justify-content: space-between; font-size: 13px; color: rgba(255, 255, 255, 0.7); }
    .volume-container { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; }
    .volume-icon { color: rgba(255, 255, 255, 0.7); font-size: 18px; }
    .volume-slider { flex: 1; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; outline: none; cursor: pointer; -webkit-appearance: none; }
    .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #ff6b6b; border-radius: 50%; cursor: pointer; }
    .quality-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); }
    .quality-label { display: flex; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.8); font-size: 14px; }
    .quality-select { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #fff; padding: 8px 12px; outline: none; cursor: pointer; font-size: 14px; }
    .quality-select option { background: #2a2a2a; color: #fff; padding: 8px; }
    .download-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .download-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: #fff; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
    .download-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); border-color: #ff6b6b; color: #ff6b6b; }
    .download-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .song-actions { display: flex; gap: 8px; margin-right: 15px; }
    .action-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: none; color: rgba(255, 255, 255, 0.7); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .action-btn:hover { background: rgba(255, 107, 107, 0.3); color: #ff6b6b; transform: scale(1.1); }
    .list-section { height: 40vh; overflow: auto; margin-bottom: 10px; }
    .lyrics-section { height: 40vh; overflow: hidden; display: flex; flex-direction: column; }
    .lyrics-container { flex: 1; overflow-y: auto; padding-right: 22px; }
    .lyric-line, .lyric-empty { padding: 5px 0; transition: all 0.3s ease; border-radius: 6px; padding-left: 10px; margin-bottom: 0px; color: rgba(255, 255, 255, 0.6); line-height: 1.6; }
    .lyric-line:hover { background: rgba(255, 255, 255, 0.05); color: rgba(255, 255, 255, 0.8); }
    .lyric-line.active { color: #ff6b6b; font-weight: 600; background: rgba(255, 107, 107, 0.1); transform: scale(1.02); border-left: 3px solid #ff6b6b; }
    .error, .empty-state { text-align: center; padding: 30px 20px; color: rgba(255, 255, 255, 0.7); }
    .error i, .empty-state i { font-size: 48px; margin-bottom: 15px; display: block; }
    .loading {position: fixed;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0, 0, 0, 0.7);display: flex;align-items: center;justify-content: center;flex-direction: column;color: #aaa;}
    .loading i {animation: spin 1s linear infinite;color: #ff6b6b;width: 30px;height: 30px;font-size: 30px;margin: 10px auto;}
    .list-section .song-item { padding: 4px 8px; font-size: 14px; border-bottom: 1px solid rgba(153, 153, 153, 0.3); }
    .flt-tool, .logo .m { display: none; }
    .lyrics-section.full {position: fixed;top: 0;left: 0;width: 100vw;height: 100dvh;z-index: 999;text-align: center;background: rgba(0, 0, 0, 0.5); font-size: 50px;}
    @keyframes spin { from { transform: rotate(0deg); }  to { transform: rotate(360deg); } }
    .error i { color: #ff5252; }
    .empty-state i { color: rgba(255, 255, 255, 0.4); }
    @media (max-width: 768px) { 
      .navbar { padding: 6px 0; }
      .logo { width: 100%;     justify-content: space-between; }
      .logo .m { font-size: 0; display: block; }
      .logo .m i {margin-right: 6px;color: #ddd;font-size: 19px;background: rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 3px 6px;width: 30px;text-align: center;}
      .wrap-box { padding: 14px 8px; }
      .nav-container { flex-direction: column; gap: 6px; padding: 0 10px; }
      .main-container { padding: 10px; grid-template-columns: 1fr; gap: 14px; }
      .search-container { margin: 0; max-width: none; width: 100%; }
      .content-section {  min-height: 40vh; max-height: 54vh; }
      .current-cover { width: 120px; height: 120px; }
      .player-controls { gap: 15px; }
      .search-input { padding: 8px 8px 8px 12px; font-size: 13px; }
      .search-results { max-height: 60vh; }
      .source-select { padding: 8px 3px;  font-size: 13px; width: 100px; }
      .search-btn { padding: 8px 12px; font-size: 13px; }
      .song-item { padding: 6px 8px; }
      .song-name { font-size: 14px; font-weight: normal; }
      .song-duration { display: none; }
      .action-btn { width: 26px; height: 26px; }
      .current-song { margin-bottom: 15px; }
      .download-container { margin-bottom: 0; }
      .list-section { height: 70vh; }
      .lyrics-section { height: 50vh; }
      .flt-tool { display: flex; position: fixed; top: 43%; right: 4px; flex-direction: column; gap: 6px; z-index: 99; padding: 7px 4px; border-radius: 6px; background: #333; opacity: .7;}
      .flt-tool i { color: #ddd; font-size: 16px; }
      .lyrics-section.full { font-size: 18px; }
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 8px; }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>
    <div class="flt-tool">
      <i class="fas m fa-search" @click="goTo('.content-section')"></i><i class="fas fa-circle-play" @click="goTo('.player-section')"></i>
      <i class="fas m fa-list-ul"  @click="goTo('.list-section')"></i><i class="fas m fa-music"  @click="goTo('.lyrics-section')"></i>
    </div>
    <!-- 顶部导航 -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo">
          <div :title="'点击切换' + (isAList ? '云音乐' : 'AList')" @click="toggleSite" class="cursor"><i class="fas fa-music"></i><span>云音乐</span></div>
          <div class="m"><i class="fas fa-step-backward" @click="prevSong"></i><i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'" @click="togglePlay"></i><i class="fas fa-step-forward" @click="nextSong"></i></div>
        </div>
        <div class="search-container">
          <div class="search-wrapper">
            <input type="search" class="search-input" placeholder="搜索音乐、歌手、专辑..." v-model="searchKeyword" @keyup.enter="searchMusic" >
            <select class="source-select" v-model="selectedSource" @change="sourceChange">
              <option v-for="item in options" :value="item.v">{{ item.k }}</option>
            </select>
            <button class="search-btn" @click="searchMusic"><i class="fas fa-search"></i></button>
          </div>
        </div>
      </div>
    </nav>
    <!-- 主要内容 -->
    <div class="main-container">
      <!-- 搜索结果区域 -->
      <div class="content-section wrap-box">
        <h2 class="section-title">
          <i class="fas fa-list-ol" title="双击重置Alist配置" onclick="resetAlist()"></i>{{ isAList ? 'AList曲库' : '搜索结果' }}<span></span>
          <i class="fas fa-rotate cursor" v-show="isAList" @click="refresh"></i>
        </h2>
        <div class="search-results" id="searchResults">
          <div class="empty-state" v-if="!searchResults.length">
            <i class="fas fa-search"></i>
            <div>在上方搜索框输入关键词开始搜索音乐</div>
            <div>点击LOGO可以切换"云音乐"或"AList"</div>
          </div>
          <div 
            v-for="(song, index) in searchResults" 
            :key="index" 
            class="song-item"
            :class="{ active: currIndSh === index }"
            @click="playSong(index, true)"
          >
            <div class="song-index">{{ (index + 1).toString().padStart(2, '0') }}</div>
            <div class="song-info">
              <div class="song-name">{{ song.name }}</div>
              <div class="song-artist">
                {{ Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist }}{{ song.album ? ` · ${song.album}` : '' }}
              </div>
            </div>
            <div class="song-actions">
              <button class="action-btn" @click.stop="addPlayList(song)" title="添加到播放列表">
                <i class="fas fa-plus"></i>
              </button>
              <button class="action-btn" @click.stop="downloadSong(index, true)" title="下载音乐">
                <i class="fas fa-download"></i>
              </button>
              <button class="action-btn" @click.stop="downloadLyric(index, true)" title="下载歌词">
                <i class="fas fa-file-text"></i>
              </button>
            </div>
            <div class="song-duration">--:--</div>
          </div>
        </div>
      </div>
      <!-- 播放器区域 -->
      <div class="player-section wrap-box">
        <div class="current-song">
          <div class="current-cover-container">
            <img class="current-cover" :src="currentSong.cover || albumSbgImg" :class="{ playing: isPlaying}" alt="专辑封面" >
          </div>
          <div class="current-info">
            <h3>{{ currentSong.title || '未选择歌曲' }}</h3>
            <p>{{ currentSong.artist || '请搜索并选择要播放的歌曲' }}</p>
          </div>
        </div>

        <div class="player-controls">
          <button class="control-btn small" @click="toggleMode">
            <i class="fas" :class="{ 'fa-shuffle': playMode == 'random', 'fa-repeat': playMode == 'loop', 'fa-1': playMode == 'one' }"></i>
          </button>
          <button class="control-btn small" @click="prevSong" title="[Ctrl + ←]">
            <i class="fas fa-step-backward"></i>
          </button>
          <button class="control-btn play-btn" @click="togglePlay" title="[Space]">
            <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
          </button>
          <button class="control-btn small" @click="nextSong" title="[Ctrl + →]">
            <i class="fas fa-step-forward"></i>
          </button>
          <button class="control-btn small" @click="toggleMode" title="重新获取网络链接">
            <i class="fas fa-globe" @click="playSong(currInd, false, null, true)"></i>
          </button>
        </div>
        <div class="progress-container">
          <div class="progress-bar" @click="seekTo($event)" title="[左箭头 | 右箭头]">
            <div class="progress-fill" :style="{ width: progress + '%' }"></div>
          </div>
          <div class="time-info">
            <span>{{ formatTime(currentTime) }}</span>
            <span>{{ formatTime(totalTime) }}</span>
          </div>
        </div>
        <!-- 音质选择 -->
        <div class="quality-container" v-if="!isAList">
          <div class="quality-label"><i class="fas fa-music"></i><span>音质</span></div>
          <select class="quality-select" v-model="selectedQuality" @change="changeQuality" >
            <option value="128">标准 128K</option>
            <option value="192">较高 192K</option>
            <option value="320" selected>高品质 320K</option>
            <option value="740">无损 FLAC</option>
            <option value="999">Hi-Res</option>
          </select>
        </div>
        <div class="volume-container">
          <i :class="volumeIconClass" @click="setVolume(volume, true)"></i>
          <input type="range" class="volume-slider" min="0" max="100" v-model="volume" @input="setVolume(volume)" >
        </div>
        <!-- 下载区域 -->
        <div class="download-container">
          <button class="download-btn" @click="downloadCurrentSong" :disabled="currInd===-1" >
            <i class="fas fa-download"></i><span>下载音乐</span>
          </button>
          <button class="download-btn" @click="downloadCurrentLyric" :disabled="currInd===-1" >
            <i class="fas fa-file-text"></i><span>下载歌词</span>
          </button>
        </div>
        <audio 
          ref="audioPlayer" 
          preload="metadata"
          @timeupdate="updateProgress"
          @loadedmetadata="updateTotalTime"
          @ended="nextSong(false)"
          @play="isPlaying = true"
          @pause="isPlaying = false"
        ></audio>
      </div>
      <!-- 播放列表歌词区域 -->
      <div>
        <div class="list-section wrap-box">
          <h2 class="section-title">
            <i class="fas fa-list-ul"></i>播放列表
            <span><template v-if="playList.length">[ 共 {{ playList.length }} 条 ]</template></span>
            <i class="fas cursor fa-upload" @click="uploadList" title="上传歌曲列表"></i>
            <i class="fas cursor fa-download" @click="downloadList" title="下载歌曲列表"></i>
          </h2>
          <div class="list-container" ref="listContainer">
            <div class="lyric-empty" v-if="!playList.length">请先添加歌曲</div>
            <div 
              v-for="(song, index) in playList" 
              :key="index" 
              class="song-item"
              :class="{ active: currInd === index }"
              @click="playSong(index)"
            >
              <div class="song-info">
                <div class="song-name">{{ song.name }}</div>
                <div class="song-artist">
                  {{ Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist }} · {{ song.album }}
                </div>
                <i class="fas fa-minus-circle" @click.stop="delPlayList(index)"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="lyrics-section wrap-box" :class="{ 'full': lyricFull }" :style="{ 'font-size': lyricFull ? lyricFontSize + 'px' : '16px' }">
          <h2 class="section-title">
            <i class="fas fa-align-left" @click="loadLyrics(currentSong.raw, true)" title="强制请求歌词"></i><b>歌词</b>
            <span v-if="lyricsEnd">[ end: {{ formatTime(lyricsEnd) }} ]</span>
            <i class="fas cursor fa-right-left" v-if="isAList && !currentSong.lyric" @click="loadLyrics(currentSong.raw, true, true)"></i>
            <i class="fas cursor" :class="{ 'fa-upload': isAList && !currentSong.lyric && lyrics.length }" @click="uploadLyric"></i>
            <i class="fas cursor fa-plus" v-show="lyricFull" @click="setFontSize(true)"></i>
            <i class="fas cursor fa-minus" v-show="lyricFull" @click="setFontSize(false)"></i>
            <i class="fas cursor" :class="[ lyricLock ? 'fa-lock' : 'fa-lock-open' ]" @click="lyricLock = !lyricLock"></i>
            <i class="fas cursor" :class="[ lyricFull ? 'fa-minimize' : 'fa-expand' ]" @click="lyricFull = !lyricFull"></i>
          </h2>
          <div class="lyrics-container" ref="lyricsContainer">
            <div class="lyric-empty" v-if="!lyrics.length">暂无歌词</div>
            <div 
              v-for="(lyric, index) in lyrics" 
              :key="index"
              class="lyric-line"
              :class="{ active: currentLyricIndex === index, cursor: !lyricLock }"
              @click="seekToLyric(lyric.time)"
            >
              <!-- @click="seekToLyric(lyric.time)" -->
              {{ lyric.text }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="loading hide" id="loadingRef"><i class="fas fa-spinner"></i><div>加载中...</div></div>

  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/vue/3.5.17/vue.global.prod.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/axios/1.11.0/axios.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
  <script>
    /******************************************* 工具类 *******************************************/
    localforage.config({ driver: localforage.INDEXEDDB, name: 'gdmusic-db', storeName: 'gdmusic-store' });
    async function getStorage(key) {
      const data = await localforage.getItem(key)
      let text = null
      if (data) {
        try {
          text = pako.inflate(data, { to: 'string' });
          return JSON.parse(text)
        } catch (error) {
          console.log('parse error', error);
          return text
        }
      }
      return text
    }
    function setStorage(key, val) {
      if (!val && val !== 0) return localforage.removeItem(key)
      let text = JSON.stringify(val)
      const data = pako.deflate(new TextEncoder().encode(text), { level: 9 });
      localforage.setItem(key, data).then(() => {
        const size = data.length / 1024;
        const size1 = new TextEncoder().encode(text).length / 1024; // 转换为KB
        console.log(`存储成功: ${data.length} 长度, ${size1.toFixed(2)}kb -> ${size.toFixed(2)}kb,  压缩率: ${(100 * size / size1).toFixed(2)}%`);
      }).catch(console.error);
    }
    function setStorageExp (key, val, ttl) {
      localStorage.setItem(key, JSON.stringify({ val, exp: !ttl ? 0 : (Date.now() + ttl * 1000) }));
    }
    function getStorageExp (key) {
      const itemStr = localStorage.getItem(key);
      if (!itemStr) return null;
      const item = JSON.parse(itemStr);
      return Date.now() < item.exp || item.exp == 0 ? item.val : localStorage.removeItem(key);
    }
    function downloadText(text, name) {
      const url = URL.createObjectURL(new Blob([text], { type: 'text/plain;charset=utf-8' }));
      const link = Object.assign(document.createElement('a'), { href: url, download: name });
      document.body.appendChild(link).click();
      link.remove();
      URL.revokeObjectURL(url);
    }
    function showNotification(message, type = 'info', duration = 2) {
      const bgcolor = type === 'success' ? 'rgba(76, 175, 80, 0.9)' : type === 'error' ? 'rgba(244, 67, 54, 0.9)' :
            type === 'warning' ? 'rgba(255, 152, 0, 0.9)' : 'rgba(33, 150, 243, 0.9)'
      const notification = Object.assign(document.createElement('div'), { 
        textContent: message,
        style: `background: ${bgcolor}; position: fixed; top: 100px; right: 30px; color: white; padding: 15px 20px; border-radius: 10px; font-size: 14px;
          backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; max-width: 300px; `,
      });
      document.body.appendChild(notification);
      setTimeout(() => notification.style.transform = 'translateX(0)', 100);
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, duration * 1000);
    }
    function getRandomIndexes(len) {
      const arr = []
      while (arr.length < len) {
        const randomIndex = Math.floor(Math.random() * len)
        // 确保没有重复的值且不等于当前索引
        if (!arr.includes(randomIndex)) arr.push(randomIndex)
      }
      return arr
    }
    function toggleLoading(isShow) { loadingRef.classList.toggle('hide', !isShow) }
  </script>
  <script>
    window.API_BASE = 'https://music-api.gdstudio.xyz/api.php';
    window.albumSbgImg = `data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" class="icon" viewBox="0 0 2056 2056"><path fill="rgba(255,255,255,0.1)" d="M1420.001 512H1484v735.996c0 88.369-100.289 160.007-224.006 160.007s-224.006-71.638-224.006-160.007c0-88.37 100.289-160.008 224.006-160.008 62.688 0 119.335 18.391 160.007 48.046v-368.04L908.011 881.78v494.214c0 88.37-100.288 160.007-224.005 160.007S460 1464.362 460 1375.993s100.289-160.007 224.006-160.007c62.688 0 119.334 18.39 160.007 48.045V639.997z"/></svg>')}`;
    window.searchOptions = [ { k: "网易云音乐", v: "netease"}, { k: "QQ音乐", v: "tencent"}, { k: "酷我音乐", v: "kuwo"}, { k: "JOOX", v: "joox"}, 
      { k: "酷狗音乐", v: "kugou"}, { k: "咪咕音乐", v: "migu"}, { k: "Deezer", v: "deezer"}, { k: "Spotify", v: "spotify"}, { k: "Apple Music", v: "apple"}, 
      { k: "YouTube Music", v: "ytmusic"}, { k: "TIDAL", v: "tidal"}, { k: "Qobuz", v: "qobuz"}, { k: "喜马拉雅", v: "ximalaya"} ]
    window.cacheKey = {
      searchHistory: 'searchHistory',
      lyricHistory: 'lyricHistory',
      playList: 'playList',
      playMode: 'dm_playMode',
      fontSize: 'dm_fontSize',
      currInd: 'dm_currInd',
      currTime: 'dm_currTime',
    }
    /****************************************** 音乐相关接口, 单独提出, 方便扩展其他源 *******************************************/
    window.getSongUrl = async function(song, br) {
      try {
        return (await fetch(`${API_BASE}?types=url&id=${song.id}&source=${song.source}&br=${br}`).then(res => res.json()) || {}).url;
      } catch (e) { console.error(e); return null; }
    }
    window.getSongLyric = async function(song) {
      try {
        return (await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`).then(res => res.json()) || {}).lyric;
      } catch (e) { console.error(e); return null; }
    }
    window.getAlbumCoverUrl = async function (song, size = 300) {
      if (!song.pic_id) return albumSbgImg;
      try {
        return (await fetch(`${API_BASE}?types=pic&source=${song.source}&id=${song.pic_id}&size=${size}`).then(res => res.json()) || {}).url || albumSbgImg;
      } catch (e) { return albumSbgImg }
    }
    window.searchMusicBind = async function(keyword, source) { 
      if (!this.searchKeyword.trim()) return this.showNotification('请输入搜索关键词', 'warning');
      const key = `${source}_${keyword}`;
      if (this.searchHistory[key]) {
        this.searchResults = this.searchHistory[key];
        return
      }
      try {
        this.searchResults = await fetch(`${API_BASE}?types=search&source=${source}&name=${encodeURIComponent(keyword)}&count=30`).then(res => res.json()) || [];
      } catch (e) { console.error(e); }
      if (!this.searchResults.length) {
        return showNotification('未找到相关歌曲，请尝试其他关键词', 'warning');
      }
      this.searchHistory[key] = this.searchResults;
      setStorage(cacheKey.searchHistory, this.searchHistory);
    }
    window.refreshBind = async function() { }
    window.sourceChangeBind = async function() { }
    window.uploadLyricBind = async function() { }
    window.mixin = {}
  </script>
  <script src="alist.js"></script>
  <script>
    var vueApp = Vue.createApp({
      mixins: [mixin],
      data() {
        return {
          isAList: false,
          isMoble: window.innerWidth < 500,
          options: searchOptions,
          playMode: 'loop',
          searchKeyword: '',
          selectedSource: searchOptions[0].v,
          selectedQuality: '320',
          searchResults: [],
          searchHistory: {},
          lyricHistory: {},
          // currInd: -1,
          // currIndSh: -1,
          playList: [],
          currentSong: {
            title: '',
            artist: '',
            cover: ''
          },
          isPlaying: false,
          currentTime: 0,
          totalTime: 0,
          progress: 0,
          volume: 80,
          lyrics: [],
          currentLyricIndex: -1,
          lyricFontSize: window.innerWidth < 800 ? 18 : (getStorageExp(cacheKey.fontSize) || 50),
          lyricsEnd: null,
          lyricLock: true,
          lyricFull: false,
          historyTime: 0,
          albumSbgImg
        };
      },
      computed: {
        volumeIconClass() {
          if (this.volume == 0) return 'cursor fas fa-volume-mute volume-icon';
          if (this.volume < 50) return 'cursor fas fa-volume-down volume-icon';
          return 'cursor fas fa-volume-up volume-icon';
        },
        currIndSh() {
          return this.searchResults.length ? this.searchResults.findIndex(x => `${x.source}_${x.id}` === this.currentSong.key) : -1;
        },
        currInd() {
          return this.playList.length ? this.playList.findIndex(x => `${x.source}_${x.id}` === this.currentSong.key) : -1;
        },
      },
      methods: {
        toggleSite() { window.location.href = this.isAList ? 'index.html' : 'index.html?t=a' },
        goTo(selector) { document.querySelector(selector).scrollIntoView({ behavior: 'smooth', block: 'end' }) },
        refresh: refreshBind,
        sourceChange: sourceChangeBind,
        uploadLyric: uploadLyricBind,
        async searchMusic() {
          toggleLoading(true);
          try {
            await searchMusicBind.call(this, this.searchKeyword, this.selectedSource)
          } catch (error) {
            this.showNotification('网络连接失败，请检查网络后重试', 'error');
          } finally {
            toggleLoading();
          }
        },
        async playSong(ind, isSearch, time = 0, isForce) {
          if (ind < 0 || (isSearch && ind >= this.searchResults.length)
            || (!isSearch && ind >= this.playList.length)) return;
          // this.currIndSh = this.currInd = -1;
          // isSearch ? (this.currIndSh = ind) : (this.currInd = ind);
          const song = isSearch ? this.searchResults[ind] : this.playList[ind];
          let key = `${song.source}_${song.id}`
          if (this.currentSong.key === key && !isForce) return;
          // 更新当前歌曲信息
          this.currentSong = {
            key,
            id: song.id,
            source: song.source,
            title: song.name,
            lyric: song.lyric,
            raw: { ...song},
            artist: `${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist}${song.album ? (' · ' + song.album) : ''}`,
            cover: await getAlbumCoverUrl(song)
          };
          // 加载歌词
          this.loadLyrics(song);
          try {
            this.showNotification('正在加载音乐...', 'info');
            let songUrl = getStorageExp(key)
            if (!songUrl || isForce) {
              // 获取音乐URL
              // const response = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${this.selectedQuality}`);
              // const data = await response.json();
              songUrl = await getSongUrl(song, this.selectedQuality);
              songUrl && setStorageExp(key, songUrl, 2 * 60 * 60); // 缓存2小时
            } else {
              console.log('获取缓存音乐URL成功', song, songUrl);
            }
            if (!songUrl) {
              return this.showNotification('无法获取音乐链接，请尝试其他歌曲或更换音质', 'error');
            }

            this.addPlayList(song);
            
            this.$refs.audioPlayer.src = songUrl;
            this.historyTime = time
            this.$refs.audioPlayer.load();
            // 自动播放
            this.$refs.audioPlayer.play().then(() => {
              this.showNotification(`开始播放 ${song.artist} - ${song.name}`, 'success');
            }).catch((e) => {
              console.error('play error', e);
              // this.showNotification('播放失败，请尝试其他歌曲', 'error');
            });
          } catch (error) {
            this.showNotification('播放失败，请检查网络连接', 'error');
          }
        },
        addPlayList(song) {
          let ind = this.playList.findIndex(x => x.id === song.id)
          if (ind < 0) {
            this.playList.push(song);
            setStorage(cacheKey.playList, this.playList);
            ind = this.playList.length - 1;
          }
          setStorageExp(cacheKey.currInd, ind)
        },
        delPlayList(index) {
          if (!confirm('确定要删除此歌曲吗？')) return
          this.playList.splice(index, 1);
          setStorage(cacheKey.playList, this.playList);
        },
        uploadList() {
          uploadList(this.playList).then(() =>  this.showNotification('同步歌曲列表成功', 'success'));
        },
        downloadList() {
          downloadList().then((data) => {
            if (data && data.length) {
              if (data.length < this.playList.length && !confirm('远端歌曲比现在少，是否覆盖？')) return;
              this.playList = data;
              this.showNotification('导入歌曲列表成功', 'success');
            } else {
              this.showNotification('导入歌曲列表失败', 'error');
            }
          });
        },
        toggleMode() {
          this.playMode = this.playMode === 'loop' ? 'random' : this.playMode === 'random' ? 'one' : 'loop' ;
          if (this.playMode === 'random') {
            this.randomIndexes = getRandomIndexes(this.playList.length);
          }
          setStorageExp(cacheKey.playMode, this.playMode);
        },
        togglePlay() {
          if (!this.$refs.audioPlayer.src) return this.showNotification('请先选择要播放的歌曲', 'warning')
          this.isPlaying ? this.$refs.audioPlayer.pause() : this.$refs.audioPlayer.play();
          this.historyTime && (this.$refs.audioPlayer.currentTime = this.historyTime);
        },
        prevSong() {
          let ind = this.currInd > 0 ? this.currInd - 1 : this.playList.length - 1;
          if (this.playMode === 'random') {
            let randomInd = this.randomIndexes.indexOf(this.currInd);
            ind = this.randomIndexes[randomInd > 0 ? randomInd -1 : this.randomIndexes - 1];
          }
          this.playSong(ind)
        },
        nextSong(isManual) {
          if (isManual === false && this.playMode === 'one') {
            this.$refs.audioPlayer.currentTime = 0
            return this.$refs.audioPlayer.play()
          }
          let ind = (this.currInd + 1) % this.playList.length;
          if (this.playMode === 'random') ind = this.randomIndexes[(this.randomIndexes.indexOf(this.currInd) + 1) % this.randomIndexes.length];
          this.playSong(ind)
        },
        seekTo(event) {
          if (this.$refs.audioPlayer.duration) {
            const rect = event.target.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            this.$refs.audioPlayer.currentTime = percent * this.$refs.audioPlayer.duration;
          }
        },
        seekToLyric(time) {
          if (this.lyricLock) return
          this.$refs.audioPlayer.currentTime = time;
        },
        setVolume(value, isMute) {
          if (isMute) {
            value = value > 0 ? 0 : 80;
            this.volume = value;
          }
          this.$refs.audioPlayer.volume = value / 100;
        },
        updateProgress() {
          if (this.$refs.audioPlayer.duration) {
            this.progress = (this.$refs.audioPlayer.currentTime / this.$refs.audioPlayer.duration) * 100;
            this.currentTime = this.$refs.audioPlayer.currentTime;
            setStorageExp(cacheKey.currTime, this.currentTime);
            this.updateLyricHighlight();
          }
        },
        updateTotalTime() {
          this.totalTime = this.$refs.audioPlayer.duration;
        },
        changeQuality() {
          if (this.currInd !== -1 && this.$refs.audioPlayer.src) {
            const currentTime = this.$refs.audioPlayer.currentTime;
            const wasPlaying = this.isPlaying;
            
            this.playSong(this.currInd).then(() => {
              this.$refs.audioPlayer.currentTime = currentTime;
              !wasPlaying && this.$refs.audioPlayer.pause()
            });
          }
        },
        async loadLyrics(song, isForce, isChangeSouece) {
          if (isForce && !confirm('确定要强制重新加载远程歌词吗？')) return;
          this.lyrics = [];
          this.currentLyricIndex = -1;
          this.lyricsEnd = null;
          const key = `${song.source}_${song.id}`;
          if (this.lyricHistory[key] && !isForce) {
            return this.parseLyrics(this.lyricHistory[key]);
          }
          
          try {
            const lyric = await getSongLyric(song, isChangeSouece)
            if (lyric) {
              this.lyricHistory[key] = lyric;
              setStorage(cacheKey.lyricHistory, this.lyricHistory)
              this.parseLyrics(lyric);
            }
          } catch (e) { console.error('获取歌词失败:', e) }
        },
        parseLyrics(lrcText) {
          const lines = lrcText.split('\n');
          this.lyrics = [];
          
          lines.forEach(line => {
            const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
            if (match) {
              const minutes = parseInt(match[1]);
              const seconds = parseInt(match[2]);
              const milliseconds = parseInt(match[3].padEnd(3, '0'));
              const text = match[4].trim();
              
              if (text) {
                const time = minutes * 60 + seconds + milliseconds / 1000;
                this.lyrics.push({ time, text });
              }
            }
          });
          
          this.lyrics.sort((a, b) => a.time - b.time);
          if (this.lyrics.length) {
            this.lyricsEnd = this.lyrics[this.lyrics.length - 1].time;
          }
        },
        updateLyricHighlight() {
          const currentTime = this.$refs.audioPlayer.currentTime;
          let activeIndex = -1;
                   
          for (let i = 0; i < this.lyrics.length; i++) {
            if (this.lyrics[i].time <= currentTime) {
              activeIndex = i;
            } else {
              break;
            }
          }
          if (activeIndex === this.currentLyricIndex) return;
          this.currentLyricIndex = activeIndex;
          if (!this.lyricLock) return;
          
          if (activeIndex >= 0 && this.$refs.lyricsContainer) {
            const container = this.$refs.lyricsContainer;
            const activeLine = container.children[activeIndex];
            window.cc = container;
            window.aa = activeLine;
            if (!activeLine) return;
            
            const containerHeight = container.clientHeight;
            const lineHeight = activeLine.offsetHeight;
            const lineOffsetTop = activeLine.offsetTop;
            
            const targetScrollTop = lineOffsetTop - containerHeight / 2 + lineHeight / 2;
            
            if (this.rafId) cancelAnimationFrame(this.rafId);
            this.rafId = requestAnimationFrame(() => {
              container.scrollTop = Math.max(0, targetScrollTop);
            });
          }
        },
        setFontSize(isBig) {
          this.lyricFontSize += isBig ? 2 : -2;
          setStorageExp(cacheKey.fontSize, this.lyricFontSize)
        },
        async downloadSong(ind, isSearch) {
          const song = isSearch ? this.searchResults[ind] : this.playList[ind];
          const key = `${song.source}_${song.id}`;
          try {
            this.showNotification('正在获取下载链接...', 'info');

            let songUrl = getStorageExp(key)
            if (!songUrl) {
              // 获取音乐URL
              songUrl = await getSongUrl(song, this.selectedQuality)
              songUrl && setStorageExp(key, songUrl, 2 * 60 * 60); // 缓存2小时
            } else {
              console.log('获取缓存音乐URL成功', song, songUrl);
            }
            if (!songUrl) {
              return this.showNotification('无法获取音乐链接，请尝试其他歌曲或更换音质', 'error');
            }
            const link = Object.assign(document.createElement('a'), {
              href: songUrl,
              target: '_blank',
              download: `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.mp3`,
            })
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            this.showNotification('开始下载音乐文件', 'success');
          } catch (error) {
            this.showNotification('下载失败，请稍后重试', 'error');
          }
        },
        async downloadLyric(ind, isSearch) {
          const song = isSearch ? this.searchResults[ind] : this.playList[ind];
          
          try {
            this.showNotification('正在获取歌词...', 'info');

            const key = `${song.source}_${song.id}`;
            let lyricContent
            if (this.lyricHistory[key]) {
              lyricContent = this.lyricHistory[key];
            } else {
              lyricContent = await getSongLyric(song);
            }
            if (!lyricContent) {
              this.showNotification('无法获取歌词', 'error');
              return;
            }
            downloadText(lyricContent, `${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist} - ${song.name}.lrc`)
            this.showNotification('歌词下载完成', 'success');

          } catch (error) {
            this.showNotification('下载歌词失败，请稍后重试', 'error');
          }
        },
        downloadCurrentSong() {
          if (this.currInd === -1) {
            this.showNotification('请先选择要下载的歌曲', 'warning');
            return;
          }
          this.downloadSong(this.currInd);
        },
        downloadCurrentLyric() {
          if (this.currInd === -1) {
            this.showNotification('请先选择要下载歌词的歌曲', 'warning');
            return;
          }
          this.downloadLyric(this.currInd);
        },
        formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        },
        showNotification,
        handleKeyDown(e) {
          console.log(e);
          if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            this.togglePlay();
          } else if (e.code === 'ArrowLeft' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            if (e.ctrlKey) return this.prevSong();
            this.$refs.audioPlayer.currentTime -= 5
          } else if (e.code === 'ArrowRight' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            if (e.ctrlKey) return this.nextSong();
            this.$refs.audioPlayer.currentTime += 5
          }
        }
      },
      async mounted() {
        this.setVolume(this.volume);
        document.addEventListener('keydown', this.handleKeyDown);
        this.searchHistory = await getStorage(cacheKey.searchHistory) || {}
        this.lyricHistory = await getStorage(cacheKey.lyricHistory) || {};
        this.playList = await getStorage(cacheKey.playList) || [];
        this.playMode = getStorageExp(cacheKey.playMode) || 'loop';
        this.$nextTick(() => {
          let currInd = getStorageExp(cacheKey.currInd)
          if (this.playList.length && (currInd || currInd === 0)) {
            this.playSong(currInd, false, getStorageExp(cacheKey.currTime) || 0);
          }
        })
      },
      beforeUnmount() {
        document.removeEventListener('keydown', this.handleKeyDown);
      }
    }).mount('#app');
  </script>
</body>
</html>
